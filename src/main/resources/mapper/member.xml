<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- Member 관련 DB 접근을 담당하는 MyBatis Mapper -->
<mapper namespace="com.interviewgo.mapper.MemberMapper">

    <!--
        [로그인 / 인증용]
        username(아이디)로 회원 1명 조회
        - Spring Security의 UserDetailsService에서 사용
    -->
    <select id="getMemberByUsername" resultType="com.interviewgo.dto.MemberDTO">
        SELECT *
        FROM member
        WHERE username = #{username}
    </select>

    <!--
        [회원 정보 조회]
        회원 고유 번호(mb_uid)로 회원 정보 조회
    -->
    <select id="getMemberInfo" parameterType="Long" resultType="com.interviewgo.dto.MemberDTO">
        SELECT *
        FROM member 
        WHERE mb_uid = #{mb_uid}
    </select>

    <!--
        [회원 가입]
        신규 회원 정보 저장
        - role은 기본값 USER
        - 가입일은 NOW()
        - 기본 아이콘 경로 설정
    -->
    <insert id="insertMember" parameterType="com.interviewgo.dto.MemberDTO">
        INSERT INTO member (
            username,
            mb_password,
            mb_nickname,
            mb_pnumber,
            role,
            mb_date,
            mb_icon
        ) VALUES (
            #{username},
            #{mb_password},
            #{mb_nickname},
            #{mb_pnumber},
            'USER',
            NOW(),
            '/images/default.png'
        )
    </insert>

    <!--
        [회원 정보 수정]
        null 또는 빈 값이 아닌 항목만 동적으로 업데이트
        - 비밀번호 / 닉네임 / 전화번호 / 아이콘 변경 시 사용
    -->
    <update id="updateMember" parameterType="com.interviewgo.dto.MemberDTO">
        UPDATE member
        <set>
            <if test="mb_password != null and mb_password != ''">
                mb_password = #{mb_password},
            </if>
            <if test="mb_nickname != null and mb_nickname != ''">
                mb_nickname = #{mb_nickname},
            </if>
            <if test="mb_pnumber != null and mb_pnumber != ''">
                mb_pnumber = #{mb_pnumber},
            </if>
            <if test="mb_icon != null and mb_icon != ''">
                mb_icon = #{mb_icon},
            </if>
        </set>
        WHERE mb_uid = #{mb_uid}
    </update>

    <!--
        [비밀번호 확인]
        회원 고유 번호로 현재 비밀번호 조회
        - 비밀번호 변경 전 검증 용도
    -->
    <select id="selectPassword" parameterType="Long" resultType="string">
        SELECT mb_password
        FROM member
        WHERE mb_uid = #{mb_uid}
    </select>

    <!--
        [닉네임 중복 검사]
        - 본인(mb_uid)은 제외하고 동일 닉네임 존재 여부 확인
    -->
    <select id="checkNicknameDuplicate" resultType="int">
        SELECT COUNT(*)
        FROM member
        WHERE mb_nickname = #{nickname}
          AND mb_uid != #{mb_uid}
    </select>

    <!--
        [시험 기록 조회]
        회원의 시험 이력 조회
        - 시험 정보 / 언어 정보 JOIN
        - 최신 기록부터 정렬
    -->
    <select id="selectExamHistory" parameterType="Long"
            resultType="com.interviewgo.dto.ExamHistoryDTO">
        SELECT
            h.hist_uid,
            h.hist_score,
            h.hist_date,
            e.ex_title,
            e.ex_level,
            l.ex_lang_name
        FROM exam_history h
        INNER JOIN exam e
            ON h.ex_uid = e.ex_uid
           AND h.ex_lang_uid = e.ex_lang_uid
        INNER JOIN exam_language l
            ON h.ex_lang_uid = l.ex_lang_uid
        WHERE h.mb_uid = #{mb_uid}
        ORDER BY h.hist_date DESC
    </select>

    <!--
        [면접 기록 조회]
        회원의 면접 이력 조회
        - 최신 면접 순으로 정렬
    -->
    <select id="selectInterviewHistory" parameterType="Long"
            resultType="com.interviewgo.dto.InterviewHistoryDTO">
        SELECT *
        FROM interview_history
        WHERE mb_uid = #{mb_uid}
        ORDER BY iv_date DESC
    </select>

    <!--
        [시험 기록 삭제]
        회원 탈퇴 시 사용
    -->
    <delete id="deleteExamHistory" parameterType="Long">
        DELETE FROM exam_history
        WHERE mb_uid = #{mb_uid}
    </delete>

    <!--
        [면접 기록 삭제]
        회원 탈퇴 시 사용
    -->
    <delete id="deleteInterviewHistory" parameterType="Long">
        DELETE FROM interview_history
        WHERE mb_uid = #{mb_uid}
    </delete>

    <!--
        [회원 삭제]
        회원 탈퇴 처리
    -->
    <delete id="deleteMember" parameterType="Long">
        DELETE FROM member
        WHERE mb_uid = #{mb_uid}
    </delete>

    <!--
        [UID 기반 회원 조회]
        mb_uid로 회원 정보 조회 (다른 서비스 로직에서 사용)
    -->
    <select id="getMemberByUid" resultType="com.interviewgo.dto.MemberDTO">
        SELECT *
        FROM member
        WHERE mb_uid = #{mbUid}
    </select>

</mapper>
